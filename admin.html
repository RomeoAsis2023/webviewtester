<script>
  const baseURL = 'https://api.github.com';
  const username = 'RomeoAsis2023'; // Replace with your GitHub username
  const repoName = 'webviewtester'; // Replace with your repository name
  const hashedPassword = "e0326304cee1186e32068bd81e279821b8ae9e53fda3f0c182e04a0a68ad6f2d";

  async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(hashBuffer))
      .map(b => b.toString(16).padStart(2, "0"))
      .join("");
  }

  async function authenticate() {
    const inputPassword = document.getElementById("password").value.trim();
    const inputHashed = await hashPassword(inputPassword);

    if (inputHashed === hashedPassword) {
      localStorage.setItem("authenticated", "true");
      document.getElementById("authSection").style.display = "none";
      document.getElementById("adminSection").classList.remove("hidden");
    } else {
      const error = document.getElementById("authError");
      error.style.display = "block";
      setTimeout(() => {
        error.style.display = "none";
      }, 3000);
    }
  }

  function checkAuthentication() {
    const isAuthenticated = localStorage.getItem("authenticated");
    if (isAuthenticated === "true") {
      document.getElementById("authSection").style.display = "none";
      document.getElementById("adminSection").classList.remove("hidden");
    }
  }

  function setHeaders() {
    const token = document.getElementById('token').value;
    if (!token) {
      alert("GitHub Token is required!");
      throw new Error("Token missing");
    }
    return {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    };
  }

  function createOrUpdateSection() {
    const sectionName = document.getElementById('sectionName').value.trim();
    const sectionContent = document.getElementById('sectionContent').value.trim();

    if (!sectionName || !sectionContent) {
      alert("Section name and content are required!");
      return;
    }

    // Create JSON with HTML content
    const jsonData = {
      content: sectionContent // Allow raw HTML in content
    };

    const filePath = `resume/${sectionName}.json`;
    fetch(`${baseURL}/repos/${username}/${repoName}/contents/${filePath}`, {
      method: 'PUT',
      headers: setHeaders(),
      body: JSON.stringify({
        message: `Update section: ${sectionName}`,
        content: btoa(JSON.stringify(jsonData, null, 2)), // Encode JSON
      }),
    })
      .then((response) => response.json())
      .then(() => {
        alert("Section saved successfully!");
        listSections();
      })
      .catch((err) => console.error(err));
  }

  function listSections() {
    fetch(`${baseURL}/repos/${username}/${repoName}/contents/resume`, {
      headers: setHeaders()
    })
      .then(response => response.json())
      .then(data => {
        const tableBody = document.getElementById('sectionsTable');
        tableBody.innerHTML = '';

        data.forEach(file => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${file.name}</td>
            <td>
              <button onclick="editSection('${file.name}')">Edit</button>
              <button onclick="deleteSection('${file.name}')">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      })
      .catch(err => console.error(err));
  }

  function editSection(fileName) {
    const filePath = `resume/${fileName}`;
    fetch(`${baseURL}/repos/${username}/${repoName}/contents/${filePath}`, {
      headers: setHeaders(),
    })
      .then((response) => response.json())
      .then((data) => {
        const content = JSON.parse(atob(data.content)); // Decode Base64 and parse JSON
        document.getElementById('sectionName').value = fileName.replace('.json', '');
        document.getElementById('sectionContent').value = content.content; // Populate HTML content
      })
      .catch((err) => console.error(err));
  }

  function deleteSection(fileName) {
    const filePath = `resume/${fileName}`;
    fetch(`${baseURL}/repos/${username}/${repoName}/contents/${filePath}`, {
      headers: setHeaders(),
    })
      .then(response => response.json())
      .then(data => {
        fetch(`${baseURL}/repos/${username}/${repoName}/contents/${filePath}`, {
          method: 'DELETE',
          headers: setHeaders(),
          body: JSON.stringify({
            message: `Delete section: ${fileName}`,
            sha: data.sha,
          }),
        })
          .then(() => {
            alert("Section deleted successfully!");
            listSections();
          })
          .catch(err => console.error(err));
      })
      .catch(err => console.error(err));
  }

  document.addEventListener('DOMContentLoaded', checkAuthentication);
</script>
